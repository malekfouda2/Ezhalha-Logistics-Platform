You are continuing work on the existing ezhalha NestJS project.

Your task is to REFINEMENT AND ENFORCEMENT of the shipment creation flow.
DO NOT redesign the architecture.
DO NOT break the carrier adapter pattern.

----------------------------------
1. SHIPMENT INPUT SCHEMA (MANDATORY)
----------------------------------

When a client creates a shipment, ALL input fields MUST:

- Match carrier API requirements (FedEx first)
- Be validated using class-validator
- Be mapped 1:1 to carrier payload fields

Create canonical DTOs:

CreateShipmentDto must include:
- shipper:
  - name
  - phone
  - countryCode
  - city
  - postalCode
  - addressLine1
- recipient:
  - name
  - phone
  - countryCode
  - city
  - postalCode
  - addressLine1
- package:
  - weight
  - weightUnit
  - length
  - width
  - height
  - dimensionUnit
- shipmentType:
  - domestic | international
- serviceType (optional)
- currency

These fields MUST be mapped exactly to FedEx APIs via mapper layer.

----------------------------------
2. MULTI-CARRIER RATE DISCOVERY STEP
----------------------------------

Before shipment creation, introduce a RATE DISCOVERY step.

Flow:
1) Client submits shipment details
2) System queries ALL enabled carriers (FedEx for now)
3) Carrier adapters return:
   - carrierCode
   - carrierName
   - serviceType
   - baseRate
   - transitTime
4) Pricing engine applies margin
5) Client sees ONLY:
   - carrierName
   - serviceType
   - finalPrice
   - estimatedDelivery

Client NEVER sees baseRate.

----------------------------------
3. CARRIER SELECTION (MANDATORY)
----------------------------------

Client MUST select:
- carrierCode
- serviceType

This selection is REQUIRED before checkout.

Store selected carrier details temporarily (session / DB draft).

----------------------------------
4. CHECKOUT & PAYMENT FLOW
----------------------------------

Shipment creation MUST be split into TWO steps:

STEP 1: Rate selection
- Returns available carrier options
- No shipment created yet

STEP 2: Checkout
- Client confirms carrier + price
- Payment intent created
- Payment confirmed via webhook

ONLY AFTER PAYMENT CONFIRMATION:
- Call carrier Ship API
- Create shipment in carrier system
- Retrieve trackingNumber
- Persist shipment in DB

----------------------------------
5. TRACKING NUMBER HANDLING
----------------------------------

When shipment is created via FedEx:

- Extract carrierShipmentId
- Extract trackingNumber
- Store both in Shipment entity
- Return trackingNumber in API response

Shipment status must be updated to:
- CREATED

----------------------------------
6. DATABASE UPDATES
----------------------------------

Ensure Shipment model includes:
- carrierCode
- carrierServiceType
- carrierShipmentId
- trackingNumber
- baseRate
- marginAmount
- finalPrice

----------------------------------
7. API ENDPOINT REFINEMENT
----------------------------------

Required endpoints:

POST /shipments/rates
- Input: shipment details
- Output: list of carrier options (final price only)

POST /shipments/checkout
- Input:
  - selectedCarrierCode
  - selectedServiceType
  - pricingReferenceId
- Action:
  - Create payment intent

POST /shipments/confirm
- Triggered after payment success
- Creates carrier shipment
- Stores tracking number

GET /shipments/:id
- Returns shipment + tracking info

----------------------------------
8. SECURITY & VALIDATION
----------------------------------

Rules:
- Validate all shipment inputs
- Enforce idempotency on checkout & confirm
- Prevent price tampering
- Recalculate price server-side
- RBAC enforcement on all endpoints

----------------------------------
9. FUTURE CARRIER READINESS
----------------------------------

Design rules:
- Adding carriers MUST NOT require UI or API redesign
- Rates endpoint must support multiple carriers
- Carrier adapters remain isolated

----------------------------------
10. DELIVERABLES
----------------------------------

You MUST:
- Enforce strict field mapping
- Implement carrier selection before checkout
- Attach tracking number to shipment
- Preserve architecture integrity
- Produce production-quality code
- NOT use TODOs
